diff --git a/extensions/libxt_mac.c b/extensions/libxt_mac.c
index f171d15..71a5a3d 100644
--- a/extensions/libxt_mac.c
+++ b/extensions/libxt_mac.c
@@ -1,4 +1,9 @@
+/* Shared library add-on to iptables to add MAC address support. */
 #include <stdio.h>
+#include <netdb.h>
+#include <string.h>
+#include <stdlib.h>
+#include <getopt.h>
 #if defined(__GLIBC__) && __GLIBC__ == 2
 #include <net/ethernet.h>
 #else
@@ -7,82 +12,206 @@
 #include <xtables.h>
 #include <linux/netfilter/xt_mac.h>
 
-enum {
-	O_MAC = 0,
-};
-
 static void mac_help(void)
 {
 	printf(
 "mac match options:\n"
 "[!] --mac-source XX:XX:XX:XX:XX:XX\n"
-"				Match source MAC address\n");
+"				Match source MAC address\n"
+" --mac-destination [!] XX:XX:XX:XX:XX:XX\n"
+"				Match destination MAC address\n");
 }
 
-#define s struct xt_mac_info
-static const struct xt_option_entry mac_opts[] = {
-	{.name = "mac-source", .id = O_MAC, .type = XTTYPE_ETHERMAC,
-	 .flags = XTOPT_MAND | XTOPT_INVERT | XTOPT_PUT,
-	 XTOPT_POINTER(s, srcaddr)},
-	XTOPT_TABLEEND,
+static const struct option mac_opts[] = {
+	{ "mac-source", 1, NULL, '1' },
+	{ "mac-destination", 1, NULL, '2' },
+#if defined(CONFIG_RTL_MAC_FILTER_CARE_INPORT)
+	{ "in-port", 1, NULL, '3' },
+#endif
+	{ .name = NULL }
 };
-#undef s
 
-static void mac_parse(struct xt_option_call *cb)
+static void
+parse_mac(const char *mac, struct xt_mac *info)
+{
+	unsigned int i = 0;
+
+	if (strlen(mac) != ETH_ALEN*3-1)
+		xtables_error(PARAMETER_PROBLEM, "Bad mac address \"%s\"", mac);
+
+	for (i = 0; i < ETH_ALEN; i++) {
+		long number;
+		char *end;
+
+		number = strtol(mac + i*3, &end, 16);
+
+		if (end == mac + i*3 + 2
+		    && number >= 0
+		    && number <= 255)
+		{
+			info->macaddr[i] = number;
+		}
+		else
+			xtables_error(PARAMETER_PROBLEM,
+				   "Bad mac address `%s'", mac);
+	}
+
+}
+
+#if defined(CONFIG_RTL_MAC_FILTER_CARE_INPORT)
+static void
+parse_inPortMask(u_int8_t* info, u_int8_t *portMask)
+{
+	int i;
+	int temp;
+
+	for(i=0; i<5; i++)
+	{
+		if(info[i] != '\0'){
+			temp = info[i] - '0';
+			if(temp == 1)
+				*portMask |= 1<<i;
+		}
+	}
+}
+#endif
+
+static int
+mac_parse(int c, char **argv, int invert, unsigned int *flags,
+          const void *entry, struct xt_entry_match **match)
 {
-	struct xt_mac_info *macinfo = cb->data;
+	struct xt_mac_info *macinfo = (struct xt_mac_info *)(*match)->data;
+        switch (c) {
+        case '1':
+                if (*flags & MAC_SRC)
+                        xtables_error(PARAMETER_PROBLEM,
+                                   "mac match: Only use --mac-source ONCE!");
+                *flags |= MAC_SRC;
 
-	xtables_option_parse(cb);
-	if (cb->invert)
-		macinfo->invert = 1;
+                macinfo->flags |= MAC_SRC;
+                xtables_check_inverse(optarg, &invert, &optind, 0);
+                if (invert) {
+                        macinfo->flags |= MAC_SRC_INV;
+                }
+                parse_mac(optarg, &macinfo->srcaddr);
+                break;
+
+        case '2':
+                if (*flags & MAC_DST)
+                        xtables_error(PARAMETER_PROBLEM,
+                                   "mac match: Only use --mac-destination ONCE!");
+                *flags |= MAC_DST;
+
+                macinfo->flags |= MAC_DST;
+                xtables_check_inverse(optarg, &invert, &optind, 0);
+                if (invert){
+                        macinfo->flags |= MAC_DST_INV;
+                }
+                parse_mac(optarg, &macinfo->dstaddr);
+                break;
+
+#if defined(CONFIG_RTL_MAC_FILTER_CARE_INPORT)
+	case '3':
+		*flags |= INPORT_FLAG;
+		macinfo->flags |= INPORT_FLAG;
+		parse_inPortMask(optarg, &macinfo->inPortMask);
+		break;
+#endif
+
+        default:
+                return 0;
+        }
+
+        return 1;
 }
 
-static void print_mac(const unsigned char *macaddress)
+static void print_mac(struct xt_mac *info)
 {
 	unsigned int i;
 
-	printf(" %02X", macaddress[0]);
-	for (i = 1; i < ETH_ALEN; ++i)
-		printf(":%02X", macaddress[i]);
+	printf("%02X", info->macaddr[0]);
+	for (i = 1; i < ETH_ALEN; i++)
+		printf(":%02X", info->macaddr[i]);
+	printf(" ");
+}
+
+static void mac_check(unsigned int flags)
+{
+	if (!flags)
+		xtables_error(PARAMETER_PROBLEM,
+			   "You must specify `--mac-source' or `--mac-destination'");
 }
 
 static void
 mac_print(const void *ip, const struct xt_entry_match *match, int numeric)
 {
-	const struct xt_mac_info *info = (void *)match->data;
-	printf(" MAC");
+	struct xt_mac_info *macinfo = (struct xt_mac_info *)(match->data);
 
-	if (info->invert)
-		printf(" !");
-	
-	print_mac(info->srcaddr);
+        if (macinfo->flags & MAC_SRC) {
+                printf("source MAC  ");
+                if (macinfo->flags & MAC_SRC_INV)
+                        printf("! ");
+                print_mac(&macinfo->srcaddr);
+        }
+        if (macinfo->flags & MAC_DST) {
+                printf("destination MAC ");
+                if (macinfo->flags & MAC_DST_INV)
+                        printf("! ");
+                print_mac(&macinfo->dstaddr);
+        }
 }
 
 static void mac_save(const void *ip, const struct xt_entry_match *match)
 {
-	const struct xt_mac_info *info = (void *)match->data;
 
-	if (info->invert)
-		printf(" !");
+	        struct xt_mac_info *macinfo = (struct xt_mac_info *)(match->data);
 
-	printf(" --mac-source");
-	print_mac(info->srcaddr);
+        if (macinfo->flags & MAC_SRC) {
+                if (macinfo->flags & MAC_SRC_INV)
+                        printf("! ");
+                printf(" --mac-source ");
+                print_mac(&macinfo->srcaddr);
+                if (macinfo->flags & MAC_DST)
+                        fputc(' ', stdout);
+        }
+        if (macinfo->flags & MAC_DST) {
+                if (macinfo->flags & MAC_DST_INV)
+                        printf("! ");
+                printf(" --mac-destination ");
+                print_mac(&macinfo->dstaddr);
+        }
 }
 
 static struct xtables_match mac_match = {
-	.family		= NFPROTO_UNSPEC,
+	.family		= NFPROTO_IPV4,
+ 	.name		= "mac",
+	.version	= XTABLES_VERSION,
+	.size		= XT_ALIGN(sizeof(struct xt_mac_info)),
+	.userspacesize	= XT_ALIGN(sizeof(struct xt_mac_info)),
+	.help		= mac_help,
+	.parse		= mac_parse,
+	.final_check	= mac_check,
+	.print		= mac_print,
+	.save		= mac_save,
+	.extra_opts	= mac_opts,
+};
+
+static struct xtables_match mac_match6 = {
+	.family		= NFPROTO_IPV6,
  	.name		= "mac",
 	.version	= XTABLES_VERSION,
 	.size		= XT_ALIGN(sizeof(struct xt_mac_info)),
 	.userspacesize	= XT_ALIGN(sizeof(struct xt_mac_info)),
 	.help		= mac_help,
-	.x6_parse	= mac_parse,
+	.parse		= mac_parse,
+	.final_check	= mac_check,
 	.print		= mac_print,
 	.save		= mac_save,
-	.x6_options	= mac_opts,
+	.extra_opts	= mac_opts,
 };
 
 void _init(void)
 {
 	xtables_register_match(&mac_match);
+	xtables_register_match(&mac_match6);
 }
diff --git a/include/linux/netfilter/xt_mac.h b/include/linux/netfilter/xt_mac.h
index b892cdc..4bde2b3 100644
--- a/include/linux/netfilter/xt_mac.h
+++ b/include/linux/netfilter/xt_mac.h
@@ -1,8 +1,27 @@
 #ifndef _XT_MAC_H
 #define _XT_MAC_H
 
+#undef CONFIG_RTL_MAC_FILTER_CARE_INPORT
+#define MAC_SRC		0x01	/* Match source MAC address */
+#define MAC_DST		0x02	/* Match destination MAC address */
+#if defined(CONFIG_RTL_MAC_FILTER_CARE_INPORT)
+#define INPORT_FLAG    0x04
+#endif
+#define MAC_SRC_INV		0x10	/* Negate the condition */
+#define MAC_DST_INV		0x20	/* Negate the condition */
+
+struct xt_mac {
+    unsigned char macaddr[ETH_ALEN];
+};
+
 struct xt_mac_info {
-    unsigned char srcaddr[ETH_ALEN];
-    int invert;
+   struct xt_mac srcaddr;
+   struct xt_mac dstaddr;
+//    int invert;
+    u_int8_t flags;
+#if defined(CONFIG_RTL_MAC_FILTER_CARE_INPORT)
+    u_int8_t inPortMask;
+#endif
 };
+
 #endif /*_XT_MAC_H*/
diff --git a/include/xtables.h b/include/xtables.h
old mode 100644
new mode 100755
index 0217267..ea3dc62
--- a/include/xtables.h
+++ b/include/xtables.h
@@ -453,6 +453,8 @@ xtables_parse_interface(const char *arg, char *vianame, unsigned char *mask);
 /* this is a special 64bit data type that is 8-byte aligned */
 #define aligned_u64 u_int64_t __attribute__((aligned(8)))
 
+int xtables_check_inverse(const char option[], int *invert,
+	int *my_optind, int argc);
 extern struct xtables_globals *xt_params;
 #define xtables_error (xt_params->exit_err)
 
diff --git a/libxtables/xtables.c b/libxtables/xtables.c
old mode 100644
new mode 100755
index fb60c01..e3093a5
--- a/libxtables/xtables.c
+++ b/libxtables/xtables.c
@@ -1867,6 +1867,34 @@ void xtables_save_string(const char *value)
 	}
 }
 
+/**
+ * Check for option-intrapositional negation.
+ * Do not use in new code.
+ */
+int xtables_check_inverse(const char option[], int *invert,
+			  int *my_optind, int argc)
+{
+	if (option && strcmp(option, "!") == 0) {
+		fprintf(stderr, "Using intrapositioned negation "
+		        "(`--option ! this`) is deprecated in favor of "
+		        "extrapositioned (`! --option this`).\n");
+
+		if (*invert)
+			xt_params->exit_err(PARAMETER_PROBLEM,
+				   "Multiple `!' flags not allowed");
+		*invert = true;
+		if (my_optind != NULL) {
+			++*my_optind;
+			if (argc && *my_optind > argc)
+				xt_params->exit_err(PARAMETER_PROBLEM,
+					   "no argument following `!'");
+		}
+
+		return true;
+	}
+	return false;
+}
+
 const struct xtables_pprot xtables_chain_protos[] = {
 	{"tcp",       IPPROTO_TCP},
 	{"sctp",      IPPROTO_SCTP},
